---
phase: 01-lfo-smoothing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - plugins/cellular_automata/viewer.py
autonomous: false

must_haves:
  truths:
    - "Organism breathes in smooth sinusoidal waves with no visible snap-back or reset"
    - "LFO speed slider on control panel adjusts breathing tempo in real-time"
    - "Default LFO cycle is very slow — imperceptible growth and retreat over 30+ seconds"
    - "Running any preset for 5+ minutes shows consistent breathing without glitches"
  artifacts:
    - path: "plugins/cellular_automata/viewer.py"
      provides: "SinusoidalLFO class, LeniaLFOSystem class, LFO speed slider, smooth breathing"
      contains: "class SinusoidalLFO"
    - path: "plugins/cellular_automata/viewer.py"
      provides: "LFO speed slider in control panel"
      contains: "lfo_speed"
  key_links:
    - from: "Viewer.run() main loop"
      to: "LeniaLFOSystem.update(dt)"
      via: "delta-time phase accumulation each frame"
      pattern: "self\\.lfo_system\\.update\\(dt\\)"
    - from: "LeniaLFOSystem.get_modulated_params()"
      to: "self.engine.set_params()"
      via: "modulated values applied to engine"
      pattern: "engine\\.set_params\\(\\*\\*modulated"
    - from: "LFO speed slider"
      to: "LeniaLFOSystem.lfo_speed"
      via: "slider callback sets lfo_speed attribute"
      pattern: "lfo_speed.*slider"
    - from: "_apply_preset()"
      to: "LeniaLFOSystem.__init__(preset)"
      via: "new LFO system created from preset dict"
      pattern: "LeniaLFOSystem\\(preset\\)"
---

<objective>
Replace the state-coupled oscillator (velocity-based physics with wall bounces) with pure sinusoidal phase accumulator LFOs for Lenia parameter breathing. Add an LFO speed slider to the control panel.

Purpose: The current `_apply_lfo()` method uses force/velocity/damping physics with wall bounces that cause visible parameter snap-backs. Sinusoidal phase accumulators guarantee smooth, continuous oscillation by mathematical construction — `sin()` has no discontinuities.

Output: Smooth, organic breathing in all Lenia presets controlled by a single LFO speed slider.
</objective>

<execution_context>
@/Users/agi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/agi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-lfo-smoothing/01-RESEARCH.md
@plugins/cellular_automata/viewer.py
@plugins/cellular_automata/controls.py
@plugins/cellular_automata/presets.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace state-coupled oscillator with sinusoidal LFO system</name>
  <files>plugins/cellular_automata/viewer.py</files>
  <action>
  **Add two new classes at module level** (above the `Viewer` class, after the ENGINE_LABELS dict):

  1. `SinusoidalLFO` — a single-parameter phase accumulator:
     - `__init__(self, base_value, amplitude, frequency_hz=0.01)` — stores base, amplitude, frequency; initializes `self.phase = 0.0`
     - `update(self, dt)` — increments phase by `2.0 * math.pi * self.frequency_hz * dt`
     - `get_value(self)` — returns `self.base_value + self.amplitude * math.sin(self.phase)`
     - `reset(self)` — sets `self.phase = 0.0`

  2. `LeniaLFOSystem` — manages three independent LFOs plus a speed multiplier:
     - `__init__(self, preset)` — creates three `SinusoidalLFO` instances from preset dict values:
       - `mu_lfo`: base from `preset.get("mu", 0.15)`, amplitude `0.03`, frequency `0.015` Hz (~67s period)
       - `sigma_lfo`: base from `preset.get("sigma", 0.017)`, amplitude `0.006`, frequency `0.012` Hz (~83s period)
       - `T_lfo`: base from `preset.get("T", 10)`, amplitude `base_T * 0.25`, frequency `0.014` Hz (~71s period)
       - `self.lfo_speed = 1.0` (global speed multiplier, adjustable via slider)
     - `update(self, dt)` — calls `update(dt * self.lfo_speed)` on all three LFOs
     - `get_modulated_params(self)` — returns dict with `mu`, `sigma`, and `T` (T clamped to `int(max(3, value))`)
     - `reset_from_preset(self, preset)` — updates base_value on all three LFOs from preset dict WITHOUT resetting phase (breathing continues smoothly through preset parameter changes)
     - `reset_phase(self)` — resets phase on all three LFOs (only called on explicit user reseed)

  **Modify Viewer.__init__():**
  - Remove old LFO state variables: `self.lfo_phase`, `self._lfo_base_mu`, `self._lfo_base_sigma`, `self._lfo_base_T`, `self._mu_vel`, `self._sigma_vel`, `self._mass_smooth`
  - Add: `self.lfo_system = None` (initialized in `_apply_preset`)

  **Replace Viewer._apply_lfo():**
  - Delete the entire old `_apply_lfo()` method (lines 392-472, the state-coupled oscillator with forces, velocities, wall bounces)
  - No replacement method needed — LFO update moves into the main loop directly

  **Modify Viewer._apply_preset():**
  - Remove the block that sets `self._lfo_base_mu`, `self._lfo_base_sigma`, `self._lfo_base_T`, `self.lfo_phase = 0.0`, `self._mu_vel = 0.0`, `self._sigma_vel = 0.0`, `self._mass_smooth = 0.0` (lines 214-221)
  - Remove the `else` block that sets them to `None` (lines 222-225)
  - Replace with: `self.lfo_system = LeniaLFOSystem(preset) if new_engine_name == "lenia" else None`

  **Modify Viewer._on_reset():**
  - Remove the block that resets LFO bases, phase, velocities, mass_smooth (lines 377-384)
  - Replace with: `if self.lfo_system: self.lfo_system.reset_phase()` followed by `if self.engine_name == "lenia": self.lfo_system.reset_from_preset(preset)` — this resets phase (user explicitly hit R) AND reloads base values from preset dict (prevents drift)

  **Modify Viewer._make_param_callback():**
  - Update the mu/sigma slider callback: when user changes mu via slider, update `self.lfo_system.mu_lfo.base_value = val` (instead of `self._lfo_base_mu = val`). Same for sigma. This way the LFO oscillates around the user's chosen center point.

  **Modify Viewer.run() main loop:**
  - Replace `self._apply_lfo(dt)` call (line 588) with:
    ```python
    if self.lfo_system:
        self.lfo_system.update(dt)
        modulated = self.lfo_system.get_modulated_params()
        self.engine.set_params(**modulated)
    ```
  - In the auto-reseed block (lines 613-616): replace `self._mu_vel = 0.0`, `self._sigma_vel = 0.0`, `self._mass_smooth = 0.0`, `self.lfo_phase = 0.0` with `if self.lfo_system: self.lfo_system.reset_phase()`

  **Modify Viewer._build_panel():**
  - Add an "LFO BREATHING" section AFTER the "COLOR LAYERS" section and BEFORE the "SIMULATION" section:
    ```python
    panel.add_section("LFO BREATHING")
    self.sliders["lfo_speed"] = panel.add_slider(
        "LFO Speed", 0.0, 3.0, 1.0, fmt=".2f",
        on_change=self._on_lfo_speed_change
    )
    ```
  - Add the callback method `_on_lfo_speed_change(self, val)` that sets `self.lfo_system.lfo_speed = val` if `self.lfo_system` exists

  **Modify Viewer._sync_sliders_from_engine():**
  - Add sync for lfo_speed slider: if `"lfo_speed" in self.sliders and self.lfo_system`, set slider value to `self.lfo_system.lfo_speed`

  **CRITICAL pitfalls to avoid (from research):**
  - Do NOT read LFO base values from `self.engine.mu` — always from preset dict
  - Do NOT reset phase when user adjusts sliders (phase persists through parameter changes)
  - Do NOT use frame-count increments — always multiply by dt for frame-rate independence
  - LFO speed = 0 is valid — it freezes breathing at current phase position; engine.set_params() is still called with frozen values
  </action>
  <verify>
  Run the application and observe:
  ```bash
  cd /Users/agi/Code/daydream_scope/plugins && python3 -m cellular_automata coral
  ```
  - Application launches without errors
  - Coral preset shows visible slow breathing (mu/sigma oscillation)
  - LFO BREATHING section appears in control panel with LFO Speed slider
  - Moving LFO Speed slider changes breathing tempo
  - Setting LFO Speed to 0 freezes breathing
  - Pressing R reseeds and restarts breathing cycle
  - Switching presets (number keys 1-9) creates fresh LFO for new preset
  - No "snap-back" or sudden parameter jumps visible
  </verify>
  <done>
  - SinusoidalLFO and LeniaLFOSystem classes exist in viewer.py
  - Old state-coupled oscillator code (`_apply_lfo` with velocities, forces, wall bounces) is completely removed
  - LFO speed slider appears in "LFO BREATHING" section of control panel
  - Phase accumulation uses `dt * lfo_speed` for frame-rate independence
  - Base values loaded from preset dict (never from engine state)
  - Phase persists through slider adjustments, resets only on explicit R key
  - All Lenia presets breathe smoothly; non-Lenia engines unaffected (lfo_system is None)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete sinusoidal LFO breathing system replacing the old state-coupled oscillator. Smooth phase-accumulator breathing with LFO speed slider control.</what-built>
  <how-to-verify>
    1. Launch: `cd /Users/agi/Code/daydream_scope/plugins && python3 -m cellular_automata coral`
    2. Watch the Coral organism for 60+ seconds — it should breathe with slow, smooth undulations. No sudden snaps, jumps, or parameter resets.
    3. Look at the control panel: "LFO BREATHING" section should show an "LFO Speed" slider.
    4. Drag LFO Speed slider to 0.0 — breathing should freeze (organism still alive, just not oscillating).
    5. Drag LFO Speed to 3.0 — breathing should speed up noticeably (faster undulation).
    6. Return to 1.0 — normal slow breathing resumes.
    7. Press R to reseed — organism respawns and breathing restarts from beginning of cycle.
    8. Switch to Orbium (press 2) — breathing should start fresh for Orbium parameters.
    9. Switch to a non-Lenia engine (click Excitable or Life) — no LFO effects, no errors.
    10. Switch back to Lenia/Coral — breathing resumes with new LFO.
    11. Let it run for 5+ minutes on Coral — should breathe consistently with no glitches, no drift, no snap-backs.
  </how-to-verify>
  <resume-signal>Type "approved" if breathing is smooth and controls work, or describe any issues you see</resume-signal>
</task>

</tasks>

<verification>
- `python3 -m cellular_automata coral` launches without import errors or crashes
- No references to `self._mu_vel`, `self._sigma_vel`, `self._mass_smooth`, or the old `_apply_lfo` method remain in viewer.py
- `SinusoidalLFO` and `LeniaLFOSystem` classes are defined
- LFO Speed slider appears in the control panel
- Breathing is visibly smooth (sinusoidal, no wall-bounce artifacts)
- 5-minute run shows no drift, no snap-back, no accumulation glitches
</verification>

<success_criteria>
- Organism breathes in smooth sinusoidal waves with no visible snap-back or reset
- LFO speed slider on control panel adjusts breathing tempo in real-time (0.0 = frozen, 1.0 = default, 3.0 = fast)
- Default LFO cycle is very slow — ~67-83 second periods for mu/sigma, imperceptible growth and retreat
- Running Coral preset for 5+ minutes shows consistent breathing without glitches
- All Lenia presets breathe smoothly; non-Lenia engines are unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/01-lfo-smoothing/01-01-SUMMARY.md`
</output>
