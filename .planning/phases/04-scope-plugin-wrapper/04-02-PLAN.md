---
phase: 04-scope-plugin-wrapper
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - plugins/cellular_automata/pyproject.toml
  - plugins/cellular_automata/plugin.py
  - plugins/cellular_automata/pipeline.py
autonomous: false
requirements: [PLUG-09]

must_haves:
  truths:
    - "uv run daydream-scope install . succeeds with exit code 0"
    - "Cellular Automata pipeline is discoverable by Scope after install"
    - "Installed package does NOT contain viewer.py, controls.py, or __main__.py"
  artifacts:
    - path: "plugins/cellular_automata/pyproject.toml"
      provides: "Installable plugin package"
      contains: "cellular_automata = \"cellular_automata.plugin\""
  key_links:
    - from: "pyproject.toml entry point"
      to: "cellular_automata.plugin.register_pipelines"
      via: "Scope plugin loader reads entry_points['scope']"
      pattern: "cellular_automata.*plugin"
---

<objective>
Install the CA plugin into Scope and verify end-to-end functionality. This confirms the plugin package is correct, discoverable, and produces the expected output.

Purpose: Validate that the plugin files from Plan 01 actually work when installed into the Scope ecosystem — the package builds, installs, and Scope can load it.

Output: Working installed plugin, verified by install command + user confirmation that pipeline appears in Scope UI.
</objective>

<execution_context>
@/Users/agi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/agi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-scope-plugin-wrapper/04-01-SUMMARY.md
@plugins/cellular_automata/pyproject.toml
@plugins/cellular_automata/plugin.py
@plugins/cellular_automata/pipeline.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install plugin and verify package contents</name>
  <files>
    plugins/cellular_automata/pyproject.toml
    plugins/cellular_automata/plugin.py
    plugins/cellular_automata/pipeline.py
  </files>
  <action>
**1. Attempt install with Scope's install command:**

```bash
cd /Users/agi/Code/daydream_scope/plugins/cellular_automata
uv run daydream-scope install .
```

If `uv run daydream-scope install` is not available (Scope not installed locally), try the alternative editable install:
```bash
cd /Users/agi/Code/daydream_scope/plugins/cellular_automata
pip install -e .
```

If neither works (Scope is only on RunPod), verify the package builds correctly:
```bash
cd /Users/agi/Code/daydream_scope/plugins/cellular_automata
pip install hatchling
python3 -m hatchling build
```

**2. Verify the built wheel excludes pygame files:**

After build, inspect the wheel contents:
```bash
# List wheel contents to verify viewer.py, controls.py, __main__.py are excluded
python3 -m zipfile -l dist/*.whl | grep -E 'viewer|controls|__main__|pygame'
# Expected: NO matches (these files should be excluded)

# Verify plugin files ARE included
python3 -m zipfile -l dist/*.whl | grep -E 'plugin\.py|pipeline\.py|simulator\.py'
# Expected: all three present
```

**3. Verify installed package works headlessly:**

```bash
cd /Users/agi/Code/daydream_scope/plugins && python3 -c "
import sys
sys.modules['pygame'] = None

# Full end-to-end test
from cellular_automata.plugin import register_pipelines
from cellular_automata.pipeline import CAPipeline
import torch

# Simulate what Scope does: create pipeline via class
p = CAPipeline(sim_size=512, preset='coral')
result = p(prompt='', speed=1.0, hue=0.25)
tensor = result['video']

assert tensor.shape == (1, 512, 512, 3)
assert tensor.dtype == torch.float32
assert 0.0 <= tensor.min() and tensor.max() <= 1.0

# Test preset switch
result2 = p(preset='medusa', speed=1.0)
assert result2['video'].shape == (1, 512, 512, 3)

print('Install verification: ALL PASSED')
"
```

**4. Fix any issues found during install/build:**

If the install or build fails:
- Check pyproject.toml syntax (TOML validation)
- Check entry point format matches Scope convention
- Check hatchling can find the cellular_automata package
- Fix and retry

If the wheel contains pygame files:
- Update the exclude list in pyproject.toml
- Rebuild and re-verify
  </action>
  <verify>
1. Build or install command exits with code 0
2. `python3 -m zipfile -l dist/*.whl` shows plugin.py, pipeline.py, simulator.py included
3. `python3 -m zipfile -l dist/*.whl` does NOT show viewer.py, controls.py, __main__.py
4. Headless end-to-end test passes (pygame blocked, THWC tensor output correct)
  </verify>
  <done>
- Plugin package builds/installs successfully
- Wheel excludes pygame-dependent files (viewer.py, controls.py, __main__.py)
- Wheel includes plugin files (plugin.py, pipeline.py, simulator.py, engines, etc.)
- Headless end-to-end test passes with correct THWC output
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: User verifies plugin in Scope UI</name>
  <what-built>
Cellular Automata plugin package — builds, installs, and produces correct THWC tensors headlessly. Ready for Scope UI verification.
  </what-built>
  <how-to-verify>
**If Scope is running locally:**
1. Open the Scope interface in your browser
2. Look for "Cellular Automata" (or "cellular_automata") in the pipeline selector dropdown
3. Select it — you should see CA organism frames appearing
4. Try changing the preset dropdown — organism should switch
5. Move the speed slider — evolution rate should change
6. Move the hue slider — color should shift
7. Toggle reseed — new organism should appear

**If Scope is only on RunPod:**
This verification can be deferred to Phase 6 (RunPod Deployment). The automated tests in Task 1 confirm the plugin produces correct output. Mark as approved if:
- Task 1 build/install succeeded
- Headless THWC output test passed
- You're satisfied with the automated verification for now

**If you want to test without Scope UI:**
The headless test already confirms: (1, 512, 512, 3) float32 [0,1] tensor output, kwargs processing, preset switching, deferred warmup. The only thing not tested is whether Scope's plugin loader discovers the entry point — that requires Scope to be running.
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 4, or describe issues to fix.</resume-signal>
</task>

</tasks>

<verification>
Phase 4 complete when:
1. Plugin package builds with hatchling (exit code 0)
2. Wheel contents verified: plugin files included, pygame files excluded
3. Headless end-to-end test passes: THWC tensor, kwargs, preset switch, deferred warmup
4. User approves (either via Scope UI or accepting automated verification)
</verification>

<success_criteria>
1. `uv run daydream-scope install .` (or `pip install -e .` or `hatchling build`) succeeds
2. Built wheel does NOT contain viewer.py, controls.py, __main__.py
3. Headless test produces (1, 512, 512, 3) float32 [0,1] tensor via {"video": tensor}
4. Preset switching works in headless test
5. User approved the checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/04-scope-plugin-wrapper/04-02-SUMMARY.md`
</output>
