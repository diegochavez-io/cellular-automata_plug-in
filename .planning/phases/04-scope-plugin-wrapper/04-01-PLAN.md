---
phase: 04-scope-plugin-wrapper
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - plugins/cellular_automata/pyproject.toml
  - plugins/cellular_automata/plugin.py
  - plugins/cellular_automata/pipeline.py
  - plugins/cellular_automata/simulator.py
autonomous: true
requirements: [PLUG-01, PLUG-02, PLUG-03, PLUG-04, PLUG-05, PLUG-06, PLUG-07, PLUG-08, PLUG-10]

must_haves:
  truths:
    - "plugin.py imports CAPipeline and registers it via register_pipelines; uses @hookimpl decorator when scope.core.plugins.hookspecs is available, falls back to simple function when not"
    - "pipeline.py __call__() reads ALL runtime params from kwargs every frame"
    - "pipeline.py returns {'video': tensor} where tensor is (1, H, W, 3) float32 [0,1]"
    - "Wall-clock dt is computed via time.perf_counter() between __call__() invocations, clamped to [0.001, 0.1]"
    - "CASimulator accepts warmup=False to skip warmup at init; CAPipeline passes warmup=False"
    - "pyproject.toml entry point maps cellular_automata to cellular_automata.plugin"
    - "No pygame import in plugin.py -> pipeline.py -> simulator.py chain"
  artifacts:
    - path: "plugins/cellular_automata/pyproject.toml"
      provides: "Hatchling build config with Scope entry point"
      contains: "cellular_automata = \"cellular_automata.plugin\""
    - path: "plugins/cellular_automata/plugin.py"
      provides: "Scope plugin registration hook"
      contains: "register_pipelines"
    - path: "plugins/cellular_automata/pipeline.py"
      provides: "CAPipeline class with __call__, ui_field_config, wall-clock dt"
      contains: "class CAPipeline"
      min_lines: 60
    - path: "plugins/cellular_automata/simulator.py"
      provides: "CASimulator with warmup=True default parameter"
      contains: "warmup=True"
  key_links:
    - from: "plugins/cellular_automata/plugin.py"
      to: "plugins/cellular_automata/pipeline.py"
      via: "from .pipeline import CAPipeline"
      pattern: "from \\.pipeline import CAPipeline"
    - from: "plugins/cellular_automata/pipeline.py"
      to: "plugins/cellular_automata/simulator.py"
      via: "from .simulator import CASimulator"
      pattern: "from \\.simulator import CASimulator"
    - from: "plugins/cellular_automata/pipeline.py"
      to: "torch"
      via: "torch.from_numpy(frame_np.copy()).unsqueeze(0)"
      pattern: "torch\\.from_numpy"
---

<objective>
Create the three Scope plugin files (pyproject.toml, plugin.py, pipeline.py) and add deferred warmup support to CASimulator. This produces the complete plugin package that can be installed into Scope.

Purpose: Transform the headless CASimulator (Phase 3 output) into a proper Scope plugin package with correct tensor output, wall-clock timing, runtime kwargs, and UI configuration.

Output: Four files — pyproject.toml (build config + entry point), plugin.py (registration hook), pipeline.py (CAPipeline class), simulator.py (warmup=False support).
</objective>

<execution_context>
@/Users/agi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/agi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-scope-plugin-wrapper/04-RESEARCH.md
@.planning/phases/03-extract-casimulator/03-01-SUMMARY.md
@plugins/cellular_automata/simulator.py
@plugins/example_plugin/plugin.py
@plugins/example_plugin/pipeline.py
@plugins/example_plugin/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add warmup parameter to CASimulator and create pyproject.toml + plugin.py</name>
  <files>
    plugins/cellular_automata/simulator.py
    plugins/cellular_automata/pyproject.toml
    plugins/cellular_automata/plugin.py
  </files>
  <action>
**1. Modify CASimulator.__init__() in simulator.py to accept warmup=True parameter:**

In `simulator.py`, change the `__init__` signature from:
```python
def __init__(self, preset_key="coral", sim_size=1024):
```
to:
```python
def __init__(self, preset_key="coral", sim_size=1024, warmup=True):
```

Store `self._warmup = warmup` before the `_apply_preset` call.

**2. Modify _apply_preset() to respect the warmup flag:**

In `_apply_preset()`, find the warmup block (around line 1077-1083):
```python
# Warmup: pre-run steps so first frames show developed structure.
if new_engine_name == "lenia":
    for _ in range(200):
        self.engine.step()
elif new_engine_name == "gray_scott":
    for _ in range(1000):
        self.engine.step()
```

Change to:
```python
# Warmup: pre-run steps so first frames show developed structure.
if self._warmup:
    if new_engine_name == "lenia":
        for _ in range(200):
            self.engine.step()
    elif new_engine_name == "gray_scott":
        for _ in range(1000):
            self.engine.step()
```

This preserves viewer.py behavior (default warmup=True) while letting CAPipeline pass warmup=False.

**3. Add a public run_warmup() method to CASimulator:**

Add after the existing `render_float()` method (around line 661):
```python
def run_warmup(self):
    """Run engine-specific warmup steps.

    Called by CAPipeline on first __call__() when constructed with warmup=False.
    Also safe to call after apply_preset() if warmup was skipped.
    """
    if self.engine_name == "lenia":
        for _ in range(200):
            self.engine.step()
    elif self.engine_name == "gray_scott":
        for _ in range(1000):
            self.engine.step()
```

**4. Create pyproject.toml:**

Create `plugins/cellular_automata/pyproject.toml` following the example_plugin pattern:

```toml
[project]
name = "cellular-automata-scope-plugin"
version = "0.2.0"
description = "Bioluminescent cellular automata video source for DayDream Scope"
requires-python = ">=3.10"
dependencies = [
    "numpy>=1.24.0",
    "scipy>=1.10.0",
    "torch>=2.0.0",
]

[project.entry-points."scope"]
cellular_automata = "cellular_automata.plugin"

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.hatch.build.targets.wheel]
packages = ["cellular_automata"]
exclude = [
    "cellular_automata/viewer.py",
    "cellular_automata/controls.py",
    "cellular_automata/__main__.py",
]
```

Key points:
- NO pygame/pygame-ce in dependencies (PLUG-10)
- Entry point: `cellular_automata = "cellular_automata.plugin"` (matches Scope's `[project.entry-points."scope"]` convention)
- Exclude list: viewer.py, controls.py, __main__.py (all pygame-dependent files)
- Build backend: hatchling (matches example_plugin)

**5. Create plugin.py:**

Create `plugins/cellular_automata/plugin.py` with a **dual-pattern approach** that satisfies the `@hookimpl` requirement (PLUG-01) when the formal Scope API is available, while gracefully falling back to the simpler pattern (confirmed working in example_plugin) when it's not:

```python
"""
Plugin registration for DayDream Scope

Registers the Cellular Automata pipeline as a video source.
Uses @hookimpl decorator when Scope's formal plugin API is available,
falls back to the simpler registry pattern otherwise.
"""

try:
    from scope.core.plugins.hookspecs import hookimpl
except ImportError:
    hookimpl = None

from .pipeline import CAPipeline


if hookimpl is not None:
    @hookimpl
    def register_pipelines(register):
        """Called when Scope loads the plugin (formal @hookimpl API)."""
        register(CAPipeline)
else:
    def register_pipelines(registry):
        """Called when Scope loads the plugin (simple registry API)."""
        registry.register(
            name="cellular_automata",
            pipeline_class=CAPipeline,
            description="Bioluminescent cellular automata organism as video source",
        )
```

This dual approach:
- Satisfies PLUG-01 (`@hookimpl` decorator from `scope.core.plugins.hookspecs`) when the formal API is present
- Falls back to the working example_plugin pattern when `scope.core.plugins.hookspecs` is not importable (e.g. local dev without Scope installed)
- Both branches define `register_pipelines` at module level, so plugin discovery works either way
  </action>
  <verify>
1. `python3 -c "import sys; sys.modules['pygame'] = None; from cellular_automata.plugin import register_pipelines; print('OK')"` — must print OK (run from plugins/ directory with PYTHONPATH set)
2. Verify pyproject.toml has correct entry point: `grep 'cellular_automata = ' plugins/cellular_automata/pyproject.toml`
3. Verify simulator.py __init__ accepts warmup parameter: `grep 'warmup=True' plugins/cellular_automata/simulator.py`
4. Verify _apply_preset respects warmup flag: `grep 'self._warmup' plugins/cellular_automata/simulator.py`
5. Verify run_warmup() method exists: `grep 'def run_warmup' plugins/cellular_automata/simulator.py`
  </verify>
  <done>
- pyproject.toml exists with hatchling build, scope entry point, and pygame file exclusions
- plugin.py registers CAPipeline via @hookimpl + register(CAPipeline) when scope.core.plugins.hookspecs is available, falls back to registry.register() pattern otherwise
- CASimulator.__init__() accepts warmup=True parameter; _apply_preset() skips warmup when warmup=False
- CASimulator.run_warmup() exists for deferred warmup
- No pygame in plugin.py or its import chain (verified with sys.modules guard)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pipeline.py with CAPipeline class</name>
  <files>
    plugins/cellular_automata/pipeline.py
  </files>
  <action>
Create `plugins/cellular_automata/pipeline.py` with the complete CAPipeline class.

**CRITICAL requirements:**
- Text-only pipeline (no prepare() method, no video input)
- ALL runtime params read from kwargs in __call__() every frame (PLUG-04)
- Returns {"video": tensor} dict, not raw tensor (PLUG-05)
- Wall-clock dt via time.perf_counter() clamped to [0.001, 0.1] (PLUG-06)
- Deferred warmup: create CASimulator with warmup=False, run on first __call__() (PLUG-08)
- ui_field_config() returns UI layout for Scope controls (PLUG-02)

**Full implementation:**

```python
"""
Cellular Automata Pipeline for DayDream Scope

Text-only pipeline that generates organic CA organisms as video frames.
No video input needed — the CA simulation is the video source.
"""

import time
import torch
import numpy as np
from .simulator import CASimulator


class CAPipeline:
    """Text-only CA pipeline generating THWC tensor output for Scope."""

    def __init__(self, sim_size: int = 512, preset: str = "coral", **kwargs):
        """Load-time initialization.

        Creates CASimulator with warmup deferred to first __call__().
        Plugin loads instantly — no blocking warmup in __init__().

        Args:
            sim_size: Simulation grid resolution (512 or 1024).
            preset: Initial preset key (e.g. 'coral', 'medusa').
        """
        self.simulator = CASimulator(
            preset_key=preset, sim_size=sim_size, warmup=False
        )
        self._warmed_up = False
        self._last_time = None

    def __call__(self, prompt: str = "", **kwargs) -> dict:
        """Generate one CA frame.

        All user-controllable params are read from kwargs every frame.
        Never stored from __init__().

        Args:
            prompt: Ignored (text-only pipeline, no prompt needed).
            **kwargs: Runtime parameters from Scope UI:
                preset (str): CA preset key
                speed (float): Simulation speed multiplier
                hue (float): Hue offset 0-1
                brightness (float): Brightness multiplier
                thickness (float): Line dilation thickness
                reseed (bool): Trigger new organism seed

        Returns:
            {"video": tensor} where tensor is (1, H, W, 3) float32 [0,1]
        """
        # --- Deferred warmup (runs once on first call, not at plugin load) ---
        if not self._warmed_up:
            self.simulator.run_warmup()
            self._warmed_up = True

        # --- Read ALL runtime params from kwargs every frame (PLUG-04) ---
        preset = kwargs.get("preset", None)
        speed = kwargs.get("speed", 1.0)
        hue = kwargs.get("hue", 0.25)
        brightness = kwargs.get("brightness", 1.0)
        thickness = kwargs.get("thickness", 0.0)
        reseed = kwargs.get("reseed", False)

        # --- Preset change detection ---
        if preset is not None and preset != self.simulator.preset_key:
            self.simulator.apply_preset(preset)
            # Re-warmup for new engine (apply_preset skips warmup when
            # self._warmup is False, but we want warmup after preset switch)
            self.simulator.run_warmup()

        # --- Apply runtime params to simulator ---
        self.simulator.set_runtime_params(
            speed=speed,
            hue=hue,
            brightness=brightness,
            thickness=thickness,
            reseed=reseed,
        )

        # --- Wall-clock dt for LFO accuracy (PLUG-06) ---
        now = time.perf_counter()
        if self._last_time is None:
            dt = 1.0 / 30.0  # First frame: assume 30fps
        else:
            dt = now - self._last_time
        dt = max(0.001, min(dt, 0.1))  # Clamp to [0.001, 0.1]
        self._last_time = now

        # --- Render one frame (PLUG-05) ---
        frame_np = self.simulator.render_float(dt)  # (H, W, 3) float32 [0,1]

        # Convert to THWC torch tensor: (1, H, W, 3) float32
        # .copy() is required: render_float may share internal buffer memory
        tensor = torch.from_numpy(frame_np.copy()).unsqueeze(0)

        return {"video": tensor}

    @staticmethod
    def ui_field_config():
        """Configure how parameters appear in Scope UI (PLUG-02).

        Returns:
            dict: UI configuration for each parameter.
                  Load-time params go in 'settings' panel.
                  Runtime params go in 'controls' panel.
        """
        return {
            # --- Load-time (Settings panel — requires pipeline reload) ---
            "sim_size": {
                "order": 1,
                "panel": "settings",
                "label": "Sim Resolution",
                "choices": [512, 1024],
                "is_load_param": True,
            },
            # --- Runtime (Controls panel — updates live per-frame) ---
            "preset": {
                "order": 1,
                "panel": "controls",
                "label": "Preset",
                "choices": [
                    # Lenia presets (headless-safe)
                    "amoeba", "coral", "heartbeat", "jellyfish",
                    "lava_lamp", "nebula", "tide_pool", "mycelium",
                    # SmoothLife presets
                    "sl_gliders", "sl_worms", "sl_elastic", "sl_pulse", "sl_chaos",
                    # MNCA presets
                    "mnca_soliton", "mnca_mitosis", "mnca_worm",
                    "mnca_hunt", "mnca_coral",
                    # Gray-Scott presets
                    "reef", "deep_sea", "medusa", "labyrinth", "tentacles",
                ],
            },
            "speed": {
                "order": 2,
                "panel": "controls",
                "label": "Speed",
                "min": 0.5,
                "max": 5.0,
                "step": 0.1,
            },
            "hue": {
                "order": 3,
                "panel": "controls",
                "label": "Hue",
                "min": 0.0,
                "max": 1.0,
                "step": 0.01,
            },
            "brightness": {
                "order": 4,
                "panel": "controls",
                "label": "Brightness",
                "min": 0.1,
                "max": 3.0,
                "step": 0.1,
            },
            "thickness": {
                "order": 5,
                "panel": "controls",
                "label": "Thickness",
                "min": 0.0,
                "max": 20.0,
                "step": 0.5,
            },
            "reseed": {
                "order": 6,
                "panel": "controls",
                "label": "Reseed",
                "type": "toggle",
            },
        }
```

**Preset list note:** The choices list includes ALL presets for the 4 headless-safe engines (lenia, smoothlife, mnca, gray_scott) as defined in `PRESET_ORDERS` in presets.py. These are the internal keys that `CASimulator.apply_preset()` expects. Presets for non-headless engines (life, excitable, cca) are excluded because CASimulator would raise ValueError.

**Warmup on preset switch:** When the user selects a new preset, `apply_preset()` is called (which skips warmup due to `self._warmup=False` in the simulator). We call `run_warmup()` explicitly after `apply_preset()` so the new engine shows developed structure.
  </action>
  <verify>
1. Run the headless verification script:
```bash
cd /Users/agi/Code/daydream_scope/plugins && python3 -c "
import sys
sys.modules['pygame'] = None  # Block pygame
from cellular_automata.pipeline import CAPipeline
import torch

# Create pipeline (should not block on warmup)
p = CAPipeline(sim_size=512, preset='coral')

# First call triggers deferred warmup
result = p()
assert isinstance(result, dict), f'Expected dict, got {type(result)}'
assert 'video' in result, 'Missing video key'
tensor = result['video']
assert tensor.shape == (1, 512, 512, 3), f'Wrong shape: {tensor.shape}'
assert tensor.dtype == torch.float32, f'Wrong dtype: {tensor.dtype}'
assert tensor.min() >= 0.0, f'Values below 0: {tensor.min()}'
assert tensor.max() <= 1.0, f'Values above 1: {tensor.max()}'

# Second call should use wall-clock dt
result2 = p()
assert result2['video'].shape == (1, 512, 512, 3)

# Test runtime kwargs
result3 = p(speed=2.0, hue=0.5, brightness=1.5, thickness=1.0)
assert result3['video'].shape == (1, 512, 512, 3)

print('All assertions passed')
"
```
2. Verify ui_field_config returns dict with expected keys:
```bash
cd /Users/agi/Code/daydream_scope/plugins && python3 -c "
from cellular_automata.pipeline import CAPipeline
config = CAPipeline.ui_field_config()
assert 'preset' in config
assert 'speed' in config
assert 'hue' in config
assert 'brightness' in config
assert 'thickness' in config
assert 'reseed' in config
assert 'sim_size' in config
assert config['sim_size'].get('is_load_param') is True
print('UI config OK:', list(config.keys()))
"
```
3. Verify wall-clock dt is used (not fixed):
```bash
cd /Users/agi/Code/daydream_scope/plugins && python3 -c "
import time
from cellular_automata.pipeline import CAPipeline
p = CAPipeline(sim_size=512)
p()  # first call (warmup)
time.sleep(0.05)  # 50ms gap
p()  # second call should measure ~0.05s dt
# If we got here without error, dt tracking works
print('dt tracking OK')
"
```
  </verify>
  <done>
- pipeline.py exists with CAPipeline class
- __call__() reads preset, speed, hue, brightness, thickness, reseed from kwargs every frame
- Returns {"video": tensor} with (1, H, W, 3) float32 [0,1] tensor
- Wall-clock dt computed via time.perf_counter(), clamped to [0.001, 0.1]
- Deferred warmup: CASimulator created with warmup=False, run_warmup() on first __call__()
- ui_field_config() returns complete UI layout with preset choices, sliders, and toggle
- Preset choices list contains all headless-safe engine presets (internal keys)
- No pygame anywhere in import chain (verified with sys.modules guard)
  </done>
</task>

</tasks>

<verification>
Run the comprehensive headless verification:

```bash
cd /Users/agi/Code/daydream_scope/plugins && python3 -c "
import sys
sys.modules['pygame'] = None  # PLUG-10: no pygame in import chain

# Verify plugin.py loads
from cellular_automata.plugin import register_pipelines
print('PLUG-01: register_pipelines imported OK')

# Verify pipeline.py loads
from cellular_automata.pipeline import CAPipeline
print('PLUG-03: CAPipeline imported OK')

# Verify ui_field_config (PLUG-02)
config = CAPipeline.ui_field_config()
assert 'preset' in config and 'choices' in config['preset']
assert 'speed' in config and 'min' in config['speed']
assert 'sim_size' in config and config['sim_size'].get('is_load_param')
print('PLUG-02: ui_field_config OK')

# Create pipeline with deferred warmup (PLUG-08)
import time
t0 = time.perf_counter()
p = CAPipeline(sim_size=512)
init_time = time.perf_counter() - t0
print(f'PLUG-08: __init__ took {init_time:.3f}s (warmup deferred)')

# First call triggers warmup + THWC output (PLUG-05, PLUG-06)
import torch
result = p(prompt='', speed=1.0, hue=0.25, brightness=1.0, thickness=0.0, reseed=False)
assert isinstance(result, dict) and 'video' in result
t = result['video']
assert t.shape == (1, 512, 512, 3), f'Shape: {t.shape}'
assert t.dtype == torch.float32
assert 0.0 <= t.min() and t.max() <= 1.0
print('PLUG-05: THWC (1,512,512,3) float32 [0,1] OK')

# Verify runtime kwargs work (PLUG-04)
result2 = p(speed=3.0, hue=0.8, brightness=2.0, thickness=5.0)
assert result2['video'].shape == (1, 512, 512, 3)
print('PLUG-04: Runtime kwargs OK')

print('\\nAll PLUG verifications passed')
"
```

Also verify pyproject.toml (PLUG-07):
```bash
grep 'entry-points' plugins/cellular_automata/pyproject.toml
grep 'viewer.py' plugins/cellular_automata/pyproject.toml
grep 'pygame' plugins/cellular_automata/pyproject.toml  # Should find only in exclude list
```
</verification>

<success_criteria>
1. Four files exist: pyproject.toml, plugin.py, pipeline.py (new) + simulator.py (modified)
2. Headless import chain verified: sys.modules['pygame'] = None + all imports succeed
3. THWC output format: (1, H, W, 3) float32 [0,1] wrapped in {"video": tensor}
4. Runtime kwargs: speed/hue/brightness/thickness/reseed/preset all read from kwargs in __call__()
5. Wall-clock dt: time.perf_counter() used, clamped to [0.001, 0.1]
6. Deferred warmup: CASimulator(warmup=False) in __init__, run_warmup() on first __call__()
7. ui_field_config() returns complete UI layout with all 7 fields
</success_criteria>

<output>
After completion, create `.planning/phases/04-scope-plugin-wrapper/04-01-SUMMARY.md`
</output>
