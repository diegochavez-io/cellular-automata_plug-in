---
phase: 03-safe-parameter-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - plugins/cellular_automata/smoothing.py
  - plugins/cellular_automata/viewer.py
  - plugins/cellular_automata/engine_base.py
autonomous: true

must_haves:
  truths:
    - "Dragging any Lenia slider rapidly from min to max does not kill the organism"
    - "Parameter changes take 2-3 seconds to reach their target value (dreamy drift)"
    - "When organism mass drops critically low, it silently recovers without visible restart"
    - "mu and sigma sliders cooperate to keep organism in viable zone"
  artifacts:
    - path: "plugins/cellular_automata/smoothing.py"
      provides: "SmoothedParameter, LeniaParameterCoupler, SurvivalGuardian classes"
      min_lines: 100
    - path: "plugins/cellular_automata/viewer.py"
      provides: "Integration of smoothed parameters and survival guardian into main loop"
    - path: "plugins/cellular_automata/engine_base.py"
      provides: "get_mass() helper method on CAEngine"
  key_links:
    - from: "plugins/cellular_automata/viewer.py"
      to: "plugins/cellular_automata/smoothing.py"
      via: "import and instantiation of SmoothedParameter, LeniaParameterCoupler, SurvivalGuardian"
      pattern: "from .smoothing import"
    - from: "viewer._make_param_callback"
      to: "SmoothedParameter.set_target"
      via: "slider callback sets EMA target instead of calling engine.set_params directly"
      pattern: "set_target"
    - from: "viewer main loop"
      to: "SurvivalGuardian.check_and_rescue"
      via: "called each frame, replaces auto-reseed block"
      pattern: "check_and_rescue"
---

<objective>
Create EMA-smoothed parameter infrastructure and wire it into the viewer so that slider changes drift organically over 2-3 seconds, mu/sigma stay coupled in viable zones, and the organism silently recovers from near-death without visible restart.

Purpose: This is the core safety layer. Without it, dragging sliders kills the creature instantly. Every subsequent plan in this phase builds on these primitives.
Output: New `smoothing.py` module with SmoothedParameter, LeniaParameterCoupler, SurvivalGuardian. Modified `viewer.py` with EMA-smoothed slider callbacks and invisible rescue replacing the current auto-reseed.
</objective>

<execution_context>
@/Users/agi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/agi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-safe-parameter-control/03-RESEARCH.md
@.planning/phases/03-safe-parameter-control/03-CONTEXT.md
@plugins/cellular_automata/viewer.py
@plugins/cellular_automata/engine_base.py
@plugins/cellular_automata/lenia.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create smoothing.py with SmoothedParameter, LeniaParameterCoupler, and SurvivalGuardian</name>
  <files>plugins/cellular_automata/smoothing.py, plugins/cellular_automata/engine_base.py</files>
  <action>
Create `plugins/cellular_automata/smoothing.py` with three classes:

**SmoothedParameter** — EMA wrapper for any numeric parameter:
- `__init__(self, initial_value, time_constant=2.0)`: Store target, current, tau. Time constant is the "feel" parameter (2.0s = dreamy drift).
- `set_target(self, new_target)`: Called by slider callbacks. Just stores the target.
- `update(self, dt)`: Per-frame EMA step. Alpha = 1 - exp(-dt / tau). current += alpha * (target - current). Frame-rate independent.
- `get_value(self)`: Returns current smoothed value.
- `snap(self, value)`: Immediately set both target and current (for initialization/reset).
- Use `import math` for exp(). No numpy needed.
- Vary time constants slightly: mu=2.0s, sigma=2.2s, T=2.5s, R=2.5s for organic independence (avoid lockstep).

**LeniaParameterCoupler** — Ratio-based mu/sigma coupling:
- `__init__(self, preset)`: Store baseline_ratio from preset mu/sigma. coupling_strength=0.5. Safe bounds: mu [0.05, 0.35], sigma [0.005, 0.06].
- `couple(self, mu_target, sigma_target)`: Blend current ratio toward baseline ratio using coupling_strength. Clamp to safe bounds. Return (adjusted_mu, adjusted_sigma).
- `update_baseline(self, preset)`: Update baseline ratio from new preset (for preset morphing).
- The coupling should feel like gentle guidance, not locking. At 0.5 strength, user retains control but the creature stays alive.

**SurvivalGuardian** — Invisible density injection on near-death:
- `__init__(self, engine, critical_mass=0.002, rescue_cooldown=5.0)`: Store engine ref, thresholds.
- `check_and_rescue(self, dt)`: Decrement cooldown by dt. If engine.world.mean() < critical_mass AND cooldown <= 0, inject a gentle Gaussian blob at center (amplitude 0.05, radius = size//8). Set cooldown to 5.0s. Return True if rescued.
- Use `np.ogrid` and `np.exp` for Gaussian injection (matches existing add_blob pattern in engine_base.py).
- Do NOT call engine.seed() — that's a visible restart. The injection is subtle density that the simulation can grow from.

Also add `get_mass()` method to `CAEngine` in engine_base.py:
```python
def get_mass(self):
    """Return mean density of the world."""
    return float(self.world.mean())
```
This replaces inline `float(self.engine.world.mean())` calls.
  </action>
  <verify>
Run: `cd /Users/agi/Code/daydream_scope/plugins && python3 -c "from cellular_automata.smoothing import SmoothedParameter, LeniaParameterCoupler, SurvivalGuardian; sp = SmoothedParameter(0.15, 2.0); sp.set_target(0.30); sp.update(0.016); print(f'After 1 frame: {sp.get_value():.6f} (should be close to 0.15, not 0.30)'); [sp.update(0.016) for _ in range(300)]; print(f'After 5s: {sp.get_value():.6f} (should be close to 0.30)')"`

Verify SmoothedParameter drifts gradually (not snapping). After 1 frame at 60fps, value should barely move from 0.15. After ~5 seconds (300 frames), value should be close to 0.30.
  </verify>
  <done>
smoothing.py exists with SmoothedParameter, LeniaParameterCoupler, SurvivalGuardian classes. SmoothedParameter demonstrates 2-second EMA drift. engine_base.py has get_mass() method. All imports resolve cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire smoothed parameters and survival guardian into viewer</name>
  <files>plugins/cellular_automata/viewer.py</files>
  <action>
Modify `viewer.py` to use the smoothing infrastructure:

**1. Import smoothing classes:**
Add `from .smoothing import SmoothedParameter, LeniaParameterCoupler, SurvivalGuardian` to imports.

**2. Add smoothed parameter state to Viewer.__init__:**
- `self.smoothed_params = {}` — dict of key -> SmoothedParameter instances
- `self.param_coupler = None` — LeniaParameterCoupler (only for Lenia)
- `self.survival_guardian = None` — SurvivalGuardian (only for Lenia)

**3. Create smoothed params in _apply_preset:**
After creating/updating engine, build SmoothedParameter instances for each engine slider:
```python
self.smoothed_params = {}
for sdef in self.engine.__class__.get_slider_defs():
    key = sdef["key"]
    params = self.engine.get_params()
    tau = {"mu": 2.0, "sigma": 2.2, "T": 2.5, "R": 2.5}.get(key, 2.0)
    sp = SmoothedParameter(params.get(key, sdef["default"]), time_constant=tau)
    self.smoothed_params[key] = sp
```
For Lenia, also create:
```python
self.param_coupler = LeniaParameterCoupler(preset) if new_engine_name == "lenia" else None
self.survival_guardian = SurvivalGuardian(self.engine) if new_engine_name == "lenia" else None
```

**4. Modify _make_param_callback to set EMA targets (not engine directly):**
Instead of calling `self.engine.set_params(**{key: val})`, the callback should:
- Set `self.smoothed_params[key].set_target(val)` if key exists in smoothed_params
- For Lenia mu/sigma: apply coupling BEFORE setting targets. When user moves mu slider, couple sigma target too (and vice versa).
- Also update LFO base values through the smoothed param system.
- Do NOT call engine.set_params in the callback anymore — that happens in the main loop.

**5. Add per-frame smoothing update in main loop (after LFO, before sim step):**
After the LFO modulation block (lines ~607-610), add:
```python
# Update smoothed parameters (EMA drift toward slider targets)
if self.smoothed_params:
    for key, sp in self.smoothed_params.items():
        sp.update(dt)
    # Apply current smoothed values to engine
    smoothed_vals = {k: sp.get_value() for k, sp in self.smoothed_params.items()}
    # For integer params
    for k in ("T", "R", "num_states", "threshold"):
        if k in smoothed_vals:
            smoothed_vals[k] = int(smoothed_vals[k])
    self.engine.set_params(**smoothed_vals)
```
Important: The smoothed params should be updated AFTER LFO modulation. LFO sets base values on the SmoothedParameter targets, and the EMA drifts the actual values. When both LFO and slider interact, the smoothed parameter should use whichever was set most recently (LFO updates targets each frame for mu/sigma/T when lfo_system is active).

Design note on LFO+smoothing interaction: When LFO is active, it continuously sets targets via set_target() each frame. The SmoothedParameter EMA smooths the LFO output, adding a dreamy lag to the breathing. When user moves a slider, it updates the LFO base_value (existing behavior), and the LFO naturally incorporates the new base into its next modulated output. The SmoothedParameter then drifts toward the new LFO output. This creates the layered smoothing the user wants.

**6. Replace auto-reseed block (lines 625-636) with SurvivalGuardian:**
Replace the current `if mass < 0.002:` reseed block with:
```python
if self.survival_guardian:
    self.survival_guardian.check_and_rescue(dt)
```
Remove the old auto-reseed entirely. The guardian injects density invisibly — no seed(), no iridescent.reset(), no lfo phase reset.

**7. Update _on_reset to snap smoothed params:**
In _on_reset(), after setting engine params, snap all smoothed params to current values:
```python
for key, sp in self.smoothed_params.items():
    params = self.engine.get_params()
    if key in params:
        sp.snap(params[key])
```
This ensures reset is immediate, not smoothed.
  </action>
  <verify>
Run the viewer: `cd /Users/agi/Code/daydream_scope/plugins && python3 -m cellular_automata coral`

Manual test checklist (perform in order):
1. Coral preset loads and organism is alive and breathing
2. Drag the mu slider rapidly from 0.12 to 0.35 — organism should NOT die, parameter drifts slowly
3. Drag mu slider back to 0.12 — organism recovers, parameter drifts back
4. Drag sigma slider from 0.010 to 0.06 rapidly — organism stays alive
5. Wait 10 seconds — organism should be breathing normally
6. Press R to reset — reset should be immediate (snapped, not smoothed)
7. Switch to a different engine (Life) — should work without errors
  </verify>
  <done>
Slider changes in the viewer use EMA smoothing with 2-3 second drift. Dragging any Lenia slider rapidly does not kill the organism. The old auto-reseed block is replaced with SurvivalGuardian's invisible density injection. Reset (R key) snaps parameters immediately. Non-Lenia engines continue to work.
  </done>
</task>

</tasks>

<verification>
Phase 03 Plan 01 verification:
1. `python3 -c "from cellular_automata.smoothing import SmoothedParameter, LeniaParameterCoupler, SurvivalGuardian"` runs without error
2. SmoothedParameter demonstrates gradual drift (not instant snap) over 2 seconds
3. Running `python3 -m cellular_automata coral` shows organism alive and breathing
4. Rapid slider dragging on mu from 0.12 to 0.35 and back does NOT kill organism
5. SurvivalGuardian activates if organism mass drops below 0.002 (no visible restart)
6. R key reset is immediate (snapped values, not smoothed)
7. Switching to non-Lenia engine (Life, Excitable, Gray-Scott) works without errors
</verification>

<success_criteria>
- SmoothedParameter class exists and implements frame-rate-independent EMA with configurable time constant
- LeniaParameterCoupler exists and couples mu/sigma via ratio blending at 0.5 strength
- SurvivalGuardian exists and injects invisible Gaussian density on near-death with 5s cooldown
- All Lenia slider callbacks route through SmoothedParameter instead of direct engine.set_params
- Auto-reseed block replaced with SurvivalGuardian
- Coral preset survives aggressive slider dragging
</success_criteria>

<output>
After completion, create `.planning/phases/03-safe-parameter-control/03-01-SUMMARY.md`
</output>
