---
phase: 02-iridescent-color-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - plugins/cellular_automata/viewer.py
  - plugins/cellular_automata/controls.py
  - plugins/cellular_automata/color_layers.py
autonomous: false

must_haves:
  truths:
    - "RGB tint sliders (R, G, B) on control panel shift overall color balance"
    - "Brightness slider controls output luminance via exposure/gamma"
    - "Double-click on any slider resets it to default value"
    - "Old Core/Halo/Spark/Memory layer controls are completely removed from UI and code"
    - "color_layers.py is deleted — no dead code remains"
  artifacts:
    - path: "plugins/cellular_automata/viewer.py"
      provides: "IRIDESCENT CONTROLS section in panel with R/G/B tint + brightness sliders"
    - path: "plugins/cellular_automata/controls.py"
      provides: "Slider with double-click-to-reset behavior"
  key_links:
    - from: "viewer.py RGB tint slider callbacks"
      to: "IridescentPipeline.tint_r/tint_g/tint_b"
      via: "on_change lambda setting attribute"
      pattern: "self\\.iridescent\\.tint_"
    - from: "viewer.py brightness slider callback"
      to: "IridescentPipeline.brightness"
      via: "on_change lambda setting attribute"
      pattern: "self\\.iridescent\\.brightness"
    - from: "controls.py Slider.handle_event"
      to: "double-click detection"
      via: "MOUSEBUTTONDOWN with click count or timer"
      pattern: "double.*click|reset.*default"
---

<objective>
Add RGB tint and brightness slider controls to the panel, implement double-click-to-reset on sliders, and remove all old 4-layer color system code.

Purpose: Complete the UI side of the color pipeline swap. Users need RGB tint sliders and brightness control to adjust the iridescent look. The old layer system code must be fully removed to prevent confusion and reduce maintenance burden.

Output: Working slider controls for R/G/B tint and brightness, double-click reset on all sliders, and complete removal of `color_layers.py`.
</objective>

<execution_context>
@/Users/agi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/agi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-iridescent-color-pipeline/02-CONTEXT.md
@.planning/phases/02-iridescent-color-pipeline/02-RESEARCH.md
@.planning/phases/02-iridescent-color-pipeline/02-01-SUMMARY.md
@plugins/cellular_automata/viewer.py
@plugins/cellular_automata/controls.py
@plugins/cellular_automata/iridescent.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RGB tint + brightness sliders, double-click reset, remove old layer code</name>
  <files>
    plugins/cellular_automata/controls.py
    plugins/cellular_automata/viewer.py
    plugins/cellular_automata/color_layers.py
  </files>
  <action>
**1. Add double-click-to-reset to Slider class in controls.py:**

Modify the `Slider` class to support double-click reset:
- Add `self.default_value = value` in `__init__` (store the initial value as the reset target)
- Add `self._last_click_time = 0` in `__init__`
- In `handle_event`, for `MOUSEBUTTONDOWN` with button == 1:
  - Check if this click is within 300ms of _last_click_time AND within the track/handle area
  - If double-click detected: reset `self.value = self.default_value`, call `self.on_change(self.value)` if callback exists, update `_last_click_time`, return True
  - Otherwise: set `_last_click_time = current_time`, proceed with normal drag behavior
- Import `time` at top of controls.py (use `time.time()` for click timing)

This automatically applies to ALL sliders (including engine param sliders, LFO speed, brush size, etc.) since they all inherit from Slider. ColorSlider inherits from Slider so it gets it too.

**2. Add IRIDESCENT CONTROLS section to viewer._build_panel:**

In `viewer.py`, modify `_build_panel` to add color controls where the old "COLOR LAYERS" section used to be:

After the engine-specific sliders section, add:
```python
# --- Iridescent Color Controls ---
panel.add_section("IRIDESCENT")
self.sliders["tint_r"] = panel.add_slider(
    "Tint R", 0.0, 2.0, self.iridescent.tint_r, fmt=".2f",
    on_change=lambda v: setattr(self.iridescent, 'tint_r', v)
)
self.sliders["tint_g"] = panel.add_slider(
    "Tint G", 0.0, 2.0, self.iridescent.tint_g, fmt=".2f",
    on_change=lambda v: setattr(self.iridescent, 'tint_g', v)
)
self.sliders["tint_b"] = panel.add_slider(
    "Tint B", 0.0, 2.0, self.iridescent.tint_b, fmt=".2f",
    on_change=lambda v: setattr(self.iridescent, 'tint_b', v)
)
self.sliders["brightness"] = panel.add_slider(
    "Brightness", 0.1, 3.0, self.iridescent.brightness, fmt=".2f",
    on_change=lambda v: setattr(self.iridescent, 'brightness', v)
)
```

Slider ranges:
- Tint R/G/B: 0.0 to 2.0, default 1.0 — allows both reducing and boosting individual channels
- Brightness: 0.1 to 3.0, default 1.0 — allows dimming and brightening

**3. Update _sync_sliders_from_engine:**

Add sync for the new sliders:
```python
if "tint_r" in self.sliders:
    self.sliders["tint_r"].set_value(self.iridescent.tint_r)
if "tint_g" in self.sliders:
    self.sliders["tint_g"].set_value(self.iridescent.tint_g)
if "tint_b" in self.sliders:
    self.sliders["tint_b"].set_value(self.iridescent.tint_b)
if "brightness" in self.sliders:
    self.sliders["brightness"].set_value(self.iridescent.brightness)
```

**4. Verify no remaining references to old layer system:**

Search viewer.py for any remaining references to:
- `self.layers` — must be completely gone
- `ColorLayerSystem` — must be completely gone
- `LAYER_DEFS` — must be completely gone
- `_make_layer_callback` — must be completely gone
- `_update_swatches` — must be completely gone
- `feedback` slider — must be completely gone
- `layer_0`, `layer_1`, `layer_2`, `layer_3` slider keys — must be completely gone

**5. Delete color_layers.py:**

Remove `plugins/cellular_automata/color_layers.py` entirely. It is dead code now — the new iridescent.py replaces it completely.

Verify no other file imports from color_layers.py (check __init__.py and any other module).

**CRITICAL:** RGB tint and brightness sliders ONLY modify `self.iridescent.tint_r/g/b` and `self.iridescent.brightness`. These are post-render transforms. They must NEVER touch `self.engine.set_params()` or any simulation parameter.
  </action>
  <verify>
  1. Run `cd /Users/agi/Code/daydream_scope/plugins && python3 -c "from cellular_automata.viewer import Viewer; print('Import OK')"` — confirms no import errors after color_layers.py deletion.
  2. Run `cd /Users/agi/Code/daydream_scope/plugins && python3 -c "from cellular_automata.controls import Slider; s = Slider(0,0,200,'Test',0,1,0.5); print(f'default={s.default_value}'); print('Double-click reset ready')"` — confirms default_value attribute exists.
  3. Run `cd /Users/agi/Code/daydream_scope && grep -r 'color_layers' plugins/cellular_automata/ --include='*.py'` — should return ZERO results (no remaining references to old module).
  4. Run `cd /Users/agi/Code/daydream_scope && grep -r 'self\.layers' plugins/cellular_automata/viewer.py` — should return ZERO results.
  5. Confirm color_layers.py is deleted: `ls plugins/cellular_automata/color_layers.py` should fail with "No such file".
  </verify>
  <done>
  RGB tint sliders (R, G, B) and brightness slider appear in the IRIDESCENT section of the control panel. All sliders support double-click to reset to default value. Old Core/Halo/Spark/Memory layer controls and feedback slider are completely removed. color_layers.py is deleted. No dead references to the old system remain anywhere in the codebase.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete iridescent color pipeline replacing the old 4-layer system. The organism should display oil-slick/cuttlefish shimmer with spatial color variation and slow rainbow cycling. RGB tint sliders and brightness slider control the look. Double-click any slider to reset it.</what-built>
  <how-to-verify>
  1. Run: `cd /Users/agi/Code/daydream_scope/plugins && python3 -m cellular_automata coral`
  2. Observe the Coral organism — it should show iridescent colors, NOT the old HSV rainbow layers:
     - Dense interior and edges should have DIFFERENT colors (spatial variation)
     - Colors should slowly drift/cycle over time (hue sweep tied to LFO breathing)
     - Overall look should be cuttlefish/bioluminescent, not flat rainbow
  3. Check the control panel (TAB to toggle):
     - "IRIDESCENT" section should show Tint R, Tint G, Tint B, Brightness sliders
     - Old "COLOR LAYERS" section with Core/Halo/Spark/Memory should be GONE
     - Drag Tint R slider to 0 — reds should disappear from the image
     - Drag Brightness slider up — image should get brighter
     - Double-click any slider — it should snap back to its default value
  4. Switch engines (click Life, Excitable, Gray-Scott in ENGINE section):
     - All engines should render through the same iridescent pipeline
     - Colors should look organic and varied, not monochrome
  5. Performance: FPS shown in top HUD bar should stay above 45fps
  6. Let Coral run for 60+ seconds — colors should continually shift, organism should keep breathing
  </how-to-verify>
  <resume-signal>Type "approved" or describe visual issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `color_layers.py` is deleted — no file exists at that path
2. No imports of `color_layers` anywhere in the codebase
3. No `self.layers` references in viewer.py
4. IRIDESCENT section in panel with 4 sliders (Tint R, G, B, Brightness)
5. Double-click resets any slider to default
6. All 4 engine types render through IridescentPipeline
7. Visual: organism shows multi-hue iridescence, not old flat rainbow layers
8. Performance: under 22ms/frame at 1024x1024
</verification>

<success_criteria>
- RGB tint sliders shift color balance without affecting simulation parameters
- Brightness slider controls luminance
- Double-click resets any slider to its default value
- Old 4-layer system completely removed (code and UI)
- All engines render with iridescent colors
- Human verifies visual quality meets cuttlefish/bioluminescent aesthetic
</success_criteria>

<output>
After completion, create `.planning/phases/02-iridescent-color-pipeline/02-02-SUMMARY.md`
</output>
