---
phase: 03-safe-parameter-control
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - plugins/cellular_automata/smoothing.py
  - plugins/cellular_automata/viewer.py
  - plugins/cellular_automata/controls.py
autonomous: false

must_haves:
  truths:
    - "Pressing number keys 1-9 morphs the organism into the new preset over 2-3 seconds without reseeding"
    - "A 'Character' slider exists that moves mu/sigma together from calm to energetic"
    - "Coral preset survives stress test: dragging mu slider from 0.12 to edges and back 5+ times"
  artifacts:
    - path: "plugins/cellular_automata/smoothing.py"
      provides: "PresetMorpher class for smooth preset transitions"
      contains: "class PresetMorpher"
    - path: "plugins/cellular_automata/viewer.py"
      provides: "Preset morph integration, character slider wiring"
    - path: "plugins/cellular_automata/controls.py"
      provides: "Character slider in control panel"
  key_links:
    - from: "viewer._apply_preset"
      to: "PresetMorpher.start_morph"
      via: "preset switch starts morph instead of instant apply"
      pattern: "start_morph"
    - from: "viewer main loop"
      to: "PresetMorpher.update"
      via: "per-frame morph progress update feeds SmoothedParameter targets"
      pattern: "morph.*update"
    - from: "character slider callback"
      to: "LeniaParameterCoupler"
      via: "character value maps to mu/sigma pair via coupler"
      pattern: "character"
---

<objective>
Add smooth preset morphing (creature transforms over 2-3 seconds when switching presets, no reseed) and a high-level "Character" slider that moves mu/sigma together for intuitive control.

Purpose: This completes the "safe parameter control" vision — transitions are dreamy, presets morph organically, and users have both high-level and fine-grained control. The creature never visibly restarts.
Output: PresetMorpher class in smoothing.py. Modified viewer.py with morph integration and character slider. Visual verification of stress test.
</objective>

<execution_context>
@/Users/agi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/agi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-safe-parameter-control/03-RESEARCH.md
@.planning/phases/03-safe-parameter-control/03-CONTEXT.md
@.planning/phases/03-safe-parameter-control/03-01-SUMMARY.md
@plugins/cellular_automata/viewer.py
@plugins/cellular_automata/smoothing.py
@plugins/cellular_automata/controls.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PresetMorpher to smoothing.py and integrate into viewer</name>
  <files>plugins/cellular_automata/smoothing.py, plugins/cellular_automata/viewer.py</files>
  <action>
**Add PresetMorpher class to smoothing.py:**

```python
class PresetMorpher:
    """Smooth transition between presets without reseeding."""

    def __init__(self, morph_duration=2.5):
        self.morph_duration = morph_duration
        self.morphing = False
        self.morph_progress = 0.0
        self.source_params = {}
        self.target_params = {}

    def start_morph(self, current_params, target_preset):
        """Begin morphing from current params to target preset."""
        self.source_params = current_params.copy()
        # Filter out non-numeric preset keys
        self.target_params = {
            k: v for k, v in target_preset.items()
            if k not in ("engine", "name", "description", "seed", "density", "palette")
            and isinstance(v, (int, float))
        }
        self.morphing = True
        self.morph_progress = 0.0

    def update(self, dt):
        """Advance morph. Returns dict of interpolated params, or None if not morphing."""
        if not self.morphing:
            return None
        self.morph_progress += dt / self.morph_duration
        if self.morph_progress >= 1.0:
            self.morphing = False
            return self.target_params.copy()
        # Smoothstep cubic for organic feel
        t = self.morph_progress
        smooth_t = t * t * (3.0 - 2.0 * t)
        morphed = {}
        for key in self.target_params:
            src = self.source_params.get(key, self.target_params[key])
            tgt = self.target_params[key]
            if isinstance(tgt, (int, float)):
                morphed[key] = src + (tgt - src) * smooth_t
        return morphed

    def cancel(self):
        """Cancel active morph."""
        self.morphing = False
```

**Integrate PresetMorpher into viewer.py:**

1. Add `from .smoothing import ... PresetMorpher` to imports (extend existing import).

2. In `Viewer.__init__`, add:
   ```python
   self.preset_morpher = PresetMorpher(morph_duration=2.5)
   ```

3. **Modify `_apply_preset` to use morphing when switching within same engine:**
   Currently `_apply_preset` always creates new engine or does set_params + seed. Change it so:
   - If engine type is the SAME and engine already exists and this is NOT the initial load, start a morph instead of instant apply.
   - If engine type CHANGES, do the current instant switch (different engine needs reconstruction).
   - Skip `engine.seed()` during morphs — the organism keeps living.
   - Still update `self.preset_key`, LFO base values, panel state.
   - Store a flag `self._initial_load = True` in __init__, set to False after first _apply_preset completes.

   Logic sketch for same-engine morph:
   ```python
   if not engine_changed and self.engine is not None and not self._initial_load:
       # Morph: capture current params, start smooth transition
       current_params = self.engine.get_params()
       self.preset_morpher.start_morph(current_params, preset)
       # Update LFO bases to new preset (they'll drift via smoothing)
       if self.lfo_system:
           self.lfo_system.reset_from_preset(preset)
       # Update coupler baseline for new preset
       if self.param_coupler:
           self.param_coupler.update_baseline(preset)
       # Update palette if specified
       if "palette" in preset:
           self.iridescent.set_palette(preset["palette"])
       # Sync UI
       self._sync_sliders_from_engine()
       return  # Don't seed, don't reset
   ```

4. **Add morph update to main loop:**
   In the per-frame update section (after LFO, before/alongside smoothed params update):
   ```python
   if self.preset_morpher.morphing:
       morphed = self.preset_morpher.update(dt)
       if morphed:
           # Feed morphed values as targets to SmoothedParameter instances
           for key, val in morphed.items():
               if key in self.smoothed_params:
                   self.smoothed_params[key].set_target(val)
   ```
   This elegantly layers: morpher produces targets -> SmoothedParameter EMA drifts toward them -> engine gets smooth values. Double-smoothing creates extra-dreamy transitions.

5. **Ensure preset button/key handlers use morphing path:**
   The existing `_on_preset_select` and keydown handlers (1-9) already call `_apply_preset`. The morphing logic inside `_apply_preset` handles it. No changes needed to these handlers.
  </action>
  <verify>
Run: `cd /Users/agi/Code/daydream_scope/plugins && python3 -m cellular_automata coral`

Test morph:
1. Press number keys to switch between Lenia presets (1-9). Organism should smoothly transform over ~2.5 seconds, NOT reset/reseed.
2. Press "1" for Orbium, then "7" for Coral — the creature should drift its parameters from Orbium behavior to Coral behavior.
3. Switch to a different engine (click Life in panel) — should still do instant switch with seed (different engine type).
4. Switch back to Lenia — should instant switch (engine change).
5. Within Lenia, switch presets again — should morph smoothly.
  </verify>
  <done>
PresetMorpher class exists in smoothing.py. Switching presets within the same engine type smoothly morphs parameters over 2.5 seconds using smoothstep interpolation, without reseeding. Switching between different engine types still does instant creation. The creature never visibly restarts during same-engine preset switches.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Character slider (calm <-> energetic)</name>
  <files>plugins/cellular_automata/viewer.py</files>
  <action>
Add a high-level "Character" slider that controls the organism's overall behavior by moving mu and sigma together.

**Character mapping:**
- Value range: 0.0 (calm) to 1.0 (energetic)
- Default: 0.5 (neutral — use preset's original mu/sigma)
- At 0.0 (calm): mu pushed toward lower end of safe range, sigma narrower → organism is slow, stable, floating
- At 1.0 (energetic): mu pushed toward higher end, sigma wider → organism is active, dynamic, splitting
- Mapping uses the current preset's mu/sigma as the center point (0.5), and scales outward

**Implementation:**
1. Add `self.character_value = 0.5` to `Viewer.__init__`.

2. Add character slider to `_build_panel`, in a new section "CHARACTER" placed BEFORE the GROWTH FUNCTION section (so it's the first engine-related slider users see):
   ```python
   if self.engine_name == "lenia":
       panel.add_section("CHARACTER")
       self.sliders["character"] = panel.add_slider(
           "Character", 0.0, 1.0, 0.5, fmt=".2f",
           on_change=self._on_character_change
       )
   ```

3. Create `_on_character_change(self, val)`:
   - Store `self.character_value = val`
   - Map character value to mu/sigma offsets from the current preset baseline:
     ```python
     preset = get_preset(self.preset_key)
     base_mu = preset.get("mu", 0.15)
     base_sigma = preset.get("sigma", 0.017)

     # Character 0.5 = baseline. Scale: ±30% of safe range
     mu_range = 0.06  # ±0.06 from baseline
     sigma_range = 0.012  # ±0.012 from baseline

     offset = (val - 0.5) * 2.0  # Map [0,1] to [-1,1]
     target_mu = base_mu + offset * mu_range
     target_sigma = base_sigma + offset * sigma_range
     ```
   - Feed these through the coupling system:
     ```python
     if self.param_coupler:
         target_mu, target_sigma = self.param_coupler.couple(target_mu, target_sigma)
     ```
   - Set SmoothedParameter targets:
     ```python
     if "mu" in self.smoothed_params:
         self.smoothed_params["mu"].set_target(target_mu)
     if "sigma" in self.smoothed_params:
         self.smoothed_params["sigma"].set_target(target_sigma)
     ```
   - Also update LFO base values so breathing centers on new character:
     ```python
     if self.lfo_system:
         self.lfo_system.mu_lfo.base_value = target_mu
         self.lfo_system.sigma_lfo.base_value = target_sigma
     ```

4. In `_sync_sliders_from_engine`, sync character slider:
   ```python
   if "character" in self.sliders:
       self.sliders["character"].set_value(self.character_value)
   ```

5. In `_on_reset`, reset character to 0.5:
   ```python
   self.character_value = 0.5
   ```

Note: The character slider interacts with LFO. LFO modulates around the base values set by character. When character moves, the LFO base shifts, and the LFO naturally breathes around the new center. The SmoothedParameter EMA provides the dreamy transition between old and new character positions.
  </action>
  <verify>
Run: `cd /Users/agi/Code/daydream_scope/plugins && python3 -m cellular_automata coral`

Test character slider:
1. Panel shows "CHARACTER" section with a "Character" slider at 0.5
2. Drag character to 0.0 (calm) — organism should slowly become calmer, more stable
3. Drag character to 1.0 (energetic) — organism should slowly become more active
4. Rapid drag from 0.0 to 1.0 — organism should NOT die (coupling + smoothing protects it)
5. Press R to reset — character returns to 0.5
  </verify>
  <done>
Character slider exists in the Lenia control panel. Moving it from calm (0.0) to energetic (1.0) smoothly adjusts mu/sigma together through the coupling system. The organism responds organically over 2-3 seconds without dying. Reset restores character to neutral 0.5.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete safe parameter control system: EMA-smoothed sliders, mu/sigma coupling, invisible survival rescue, smooth preset morphing, and Character slider.</what-built>
  <how-to-verify>
Run: `cd /Users/agi/Code/daydream_scope/plugins && python3 -m cellular_automata coral`

**Stress test (Phase 3 success criteria):**

1. **Slider stress test:**
   - Drag mu slider from 0.12 all the way to 0.40 and back to 0.12
   - Repeat 5+ times rapidly
   - PASS: Organism stays alive through all 5+ cycles, never goes black

2. **Character slider test:**
   - Drag Character from 0.5 to 0.0 (calm), wait 3 seconds
   - Drag Character from 0.0 to 1.0 (energetic), wait 3 seconds
   - Repeat 3 times
   - PASS: Organism morphs behavior smoothly, never dies

3. **Preset morph test:**
   - Press "1" (Orbium), wait for morph to complete (~3s)
   - Press "7" (Coral), watch for morph (~3s)
   - Press "8" (Cardiac), watch for morph (~3s)
   - PASS: Each transition is smooth, no visible restart/flash

4. **Survival guardian test:**
   - Drag mu to extreme (0.40) and sigma to extreme (0.002) simultaneously
   - Wait 10 seconds
   - PASS: Organism may thin out but does NOT go black; guardian rescues invisibly

5. **Other engines:**
   - Switch to Life engine, then Gray-Scott
   - PASS: No errors, engines function normally (smoothing applies to their sliders too)

Type "approved" if all 5 tests pass, or describe issues.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Phase 03 Plan 02 verification:
1. PresetMorpher class exists in smoothing.py with smoothstep interpolation
2. Pressing number keys 1-9 within same engine morphs preset parameters over ~2.5 seconds
3. Organism does NOT reseed during same-engine preset switches
4. Character slider appears in panel for Lenia engine
5. Character slider moves mu/sigma together through coupling system
6. Coral preset survives stress test: mu slider from 0.12 to edges and back 5+ times
7. SurvivalGuardian prevents organism death even at extreme parameter combinations
8. All non-Lenia engines continue to function without errors
</verification>

<success_criteria>
- PresetMorpher smoothly transitions between presets over 2.5 seconds using smoothstep interpolation
- No reseed occurs during same-engine preset switches
- Character slider provides intuitive calm-energetic control for Lenia
- Coral preset survives stress test (5+ rapid mu slider cycles without death)
- SurvivalGuardian activates invisibly under extreme parameters
- Human verification confirms all 5 stress tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-safe-parameter-control/03-02-SUMMARY.md`
</output>
